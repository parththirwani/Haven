generator client {
  provider = "prisma-client"
  output   = ".././generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String       @id @default(uuid())
  username    String       @unique
  email       String       @unique
  password    String
  avatar      String?
  keySalt     String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  socialLinks Json?
  items       Item[]
  attachments Attachment[]
  audits      AuditLog[]
  sessions  Session[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}


model Item {
  id             String       @id @default(uuid())
  userId         String
  type           ItemType

  titleEnc       String
  contentEnc     String?
  metadataEnc    String?

  // Added: back-relation from AuditLog â†’ Attachment (optional many-to-one)
  linkedItems    Item[]       @relation("ItemLinks")
  linkedByItems  Item[]       @relation("ItemLinks")

  attachments    Attachment[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?

  user           User         @relation(fields: [userId], references: [id])
  audits         AuditLog[]

  @@index([userId])
  @@index([type])
  @@index([deletedAt])
}

enum ItemType {
  NOTE
  LINK
  RESOURCE
  PASSWORD
  TODO
  JOURNAL
}

model Attachment {
  id             String       @id @default(uuid())
  itemId         String
  userId         String

  metadataEnc    String
  filePath       String?
  fileHash       String?
  mimeType       String?
  sizeBytes      Int?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  item           Item         @relation(fields: [itemId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  audits         AuditLog[]

  @@index([itemId])
  @@index([userId])
}

model AuditLog {
  id           String       @id @default(uuid())
  userId       String
  itemId       String?
  attachmentId String?

  action       AuditAction
  timestamp    DateTime     @default(now())
  details      Json?

  prevHash     String?
  hash         String

  user         User         @relation(fields: [userId], references: [id])
  item         Item?        @relation(fields: [itemId], references: [id])
  attachment   Attachment?  @relation(fields: [attachmentId], references: [id])

  @@index([userId, timestamp(sort: Desc)])
  @@index([itemId])
}

enum AuditAction {
  CREATE
  VIEW
  UPDATE
  DELETE
  ATTACH_FILE
  DOWNLOAD_FILE
}